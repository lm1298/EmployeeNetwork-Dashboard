{% extends 'base.html' %}

{% block content %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Calendar</title>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.10.1/main.min.css' rel='stylesheet' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/5.10.1/main.min.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        #calendar {
            max-width: 900px;
            margin: 60px auto;
        }

        .fc-event-title {
            font-size: 16px;
        }

        .custom-event {
            padding: 5px;
            border-radius: 5px;
            color: white;
        }

        #event-list {
            max-width: 900px;
            margin: 20px auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .event-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .event-item:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>
    <div id='calendar'></div>
    <div id='event-list'>
        <h2>User Events</h2>
        {% for event in events %}
        {% if event.user == profile.user %}
        <div class="event-item">
            <strong>{{ event.title }}</strong><br>
            <em>{{ event.description }}</em><br>
            <span>{{ event.start }} - {{ event.end }}</span>
        </div>
        {% endif %}
        {% endfor %}
        <div id='events'></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var eventsEl = document.getElementById('events');
            var userId = {{ user.id }};  // Assuming you have a user object available in your template context

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listYear'
                },
                events: function (fetchInfo, successCallback, failureCallback) {
                    $.ajax({
                        url: '{% url "event-list" user_id %}',  // Ensure the URL is correct
                        data: { user_id: userId },  // Pass the user ID to the backend
                        dataType: 'json',
                        success: function (data) {
                            console.log("Fetched events:", data);  // Log the data for debugging
                            // Ensure the data format matches FullCalendar's expected format
                            const events = data.map(event => ({
                                title: event.title,
                                start: event.start,  // Ensure this is in ISO8601 string format
                                end: event.end,      // Ensure this is in ISO8601 string format
                                description: event.description,  // Optional, if you have additional fields
                                // Add any other fields you need
                            }));
                            successCallback(events);

                            // Display events in the event list
                            eventsEl.innerHTML = '';
                            events.forEach(event => {
                                const eventItem = document.createElement('div');
                                eventItem.classList.add('event-item');
                                eventItem.innerHTML = `
                                    <strong>${event.title}</strong><br>
                                    <em>${event.description || ''}</em><br>
                                    <span>${new Date(event.start).toLocaleString()} - ${event.end ? new Date(event.end).toLocaleString() : ''}</span>
                                `;
                                eventsEl.appendChild(eventItem);
                            });
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.error("Error fetching events:", textStatus, errorThrown);  // Log any errors
                            failureCallback();
                        }
                    });
                },
                eventDidMount: function (info) {
                    // Add custom properties to the event element
                    var tooltip = document.createElement('div');
                    tooltip.classList.add('custom-event');
                    tooltip.innerHTML = `
                        <strong>${info.event.title}</strong><br>
                        <em>${info.event.extendedProps.description || ''}</em><br>
                        <span>${info.event.start.toLocaleString()} - ${info.event.end ? info.event.end.toLocaleString() : ''}</span>
                    `;
                    info.el.appendChild(tooltip);
                },
            });

            calendar.render();
        });
    </script>
</body>

</html>
{% endblock %}